# 19 February 2025

## Create AWS Policy with ECR Least Privilege

- Allow authentication and repository creation
- Push and pull container images
- List images and view repository details

```
{
   "Version":"2012-10-17",
   "Statement":[
      {
         "Sid":"GetAuthorizationToken",
         "Effect":"Allow",
         "Action":[
            "ecr:GetAuthorizationToken"
         ],
         "Resource":"*"
      },
      {
         "Sid":"ManageRepositoryContents",
         "Effect":"Allow",
         "Action":[
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetRepositoryPolicy",
                "ecr:DescribeRepositories",
                "ecr:ListImages",
                "ecr:DescribeImages",
                "ecr:BatchGetImage",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload",
                "ecr:PutImage"
         ],
         "Resource":"arn:aws:ecr:<region>:<account-id>:repository/<repo-name>"
      }
   ]
}
```

## Push image to AWS ECR

1. Authenticate Docker with AWS ECR

```
aws ecr get-login-password --region <region> | docker login --username AWS --password-stdin <account-id>.dkr.ecr.<region>.amazonaws.com
```

2. Create repository in AWS ECR (returns JSON with repo URL)

```
aws ecr create-repository --repository-name <repo-name> --region <region>
```

3. Tag Your Docker Image

```
docker tag <repo-name>:latest <account-id>.dkr.ecr.<region>.amazonaws.com/<repo-name>:latest
```

4. Push Docker Image to AWS ECR

```
docker push <account-id>.dkr.ecr.<region>.amazonaws.com/<repo-name>:latest
```

## Clean Up Repository to Prevent Incurred Costs

```
aws ecr delete-repository --repository-name <repo-name> --region <region> --force
```
